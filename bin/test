#!/usr/bin/env bash

set -e

# Get script directory for reliable path handling
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ROOT_DIR="$(dirname "$SCRIPT_DIR")"

cd "$ROOT_DIR"

# Test contracts
npm install

npm run forge:build
npm run forge:coverage

npm run update-abi

# Test SDK
npm run sdk:build
npm run sdk:test

[ ! -f e2e-test/.env ] && cp e2e-test/.env.example e2e-test/.env

npm run e2e:build

# Browser tests via Docker
echo "Starting browser tests..."

PLAYWRIGHT_PORT=3100
APP_PORT=3000
PLAYWRIGHT_VERSION="1.52.0"

cleanup() {
  echo "Cleaning up..."
  [ -n "$APP_PID" ] && kill $APP_PID 2>/dev/null || true
  docker stop playwright-test-server 2>/dev/null || true
}
trap cleanup EXIT

# Stop any existing playwright container first (by name and by image)
docker stop playwright-test-server 2>/dev/null || true
docker rm playwright-test-server 2>/dev/null || true
# Also kill any other playwright containers that might be running
docker ps -q --filter "ancestor=mcr.microsoft.com/playwright:v${PLAYWRIGHT_VERSION}-noble" | xargs -r docker kill 2>/dev/null || true

# Kill any existing Next.js server on the app port
lsof -ti:$APP_PORT | xargs -r kill 2>/dev/null || true

# Start Playwright Docker server
echo "Starting Playwright Docker server..."
docker run \
  --name playwright-test-server \
  -p "$PLAYWRIGHT_PORT:$PLAYWRIGHT_PORT" \
  --rm \
  --init \
  --add-host=host.docker.internal:host-gateway \
  --workdir /home/pwuser \
  --user pwuser \
  "mcr.microsoft.com/playwright:v${PLAYWRIGHT_VERSION}-noble" \
  /bin/sh -c "npx -y playwright@${PLAYWRIGHT_VERSION} run-server --port $PLAYWRIGHT_PORT --host 0.0.0.0" &

# Start the e2e app server
echo "Starting e2e app server..."
(cd "$ROOT_DIR/e2e-test" && npm run start -- -p $APP_PORT) &
APP_PID=$!

# Wait for services to be ready
echo "Waiting for services..."
sleep 5

# Wait for Playwright server
for i in {1..30}; do
  if curl -s "http://127.0.0.1:$PLAYWRIGHT_PORT" >/dev/null 2>&1; then
    echo "Playwright server ready"
    break
  fi
  sleep 1
done

# Wait for app server
for i in {1..30}; do
  if curl -s "http://127.0.0.1:$APP_PORT" >/dev/null 2>&1; then
    echo "App server ready"
    break
  fi
  sleep 1
done

# Run browser tests
echo "Running browser tests..."
(cd "$ROOT_DIR/e2e-test" && PW_TEST_CONNECT_WS_ENDPOINT="ws://127.0.0.1:$PLAYWRIGHT_PORT/" TEST_PORT="$APP_PORT" npm run test)

echo "All tests completed successfully!"

# Cleanup
docker stop playwright-test-server 2>/dev/null || true
docker rm playwright-test-server 2>/dev/null || true
echo "Cleanup complete"